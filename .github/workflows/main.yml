name: RDP with ngrok (2 Hours)

on:
  workflow_dispatch:

jobs:
  rdp-ngrok:
    runs-on: windows-latest
    timeout-minutes: 120  # 2 jam

    steps:
      - name: Enable Remote Desktop
        run: |
          # Enable RDP
          Set-ItemProperty -Path 'HKLM:SystemCurrentControlSetControlTerminal Server' `
            -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:SystemCurrentControlSetControlTerminal ServerWinStationsRDP-Tcp' `
            -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:SystemCurrentControlSetControlTerminal ServerWinStationsRDP-Tcp' `
            -Name "SecurityLayer" -Value 0 -Force
          
          # Setup Firewall
          netsh advfirewall firewall delete rule name="RDP-ngrok" >nul 2>&1
          netsh advfirewall firewall add rule name="RDP-ngrok" dir=in action=allow protocol=TCP localport=3389
          
          # Restart service
          Restart-Service -Name TermService -Force
          Write-Host "RDP Enabled"

      - name: Create RDP User
        run: |
          $charSet = @{
            Upper = [char[]](65..90)
            Lower = [char[]](97..122)
            Number = [char[]](48..57)
            Special = ([char[]](33..47) + [char[]](58..64) + [char[]](91..96) + [char[]](123..126))
          }
          
          $rawPassword = @()
          $rawPassword += $charSet.Upper | Get-Random -Count 4
          $rawPassword += $charSet.Lower | Get-Random -Count 4
          $rawPassword += $charSet.Number | Get-Random -Count 4
          $rawPassword += $charSet.Special | Get-Random -Count 4
          
          $password = -join ($rawPassword | Sort-Object { Get-Random })
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          
          if (Get-LocalUser -Name "rdpuser" -ErrorAction SilentlyContinue) {
            Remove-LocalUser -Name "rdpuser" -Force
          }
          
          New-LocalUser -Name "rdpuser" -Password $securePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "rdpuser"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "rdpuser"
          
          echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV
          Write-Host "User created: rdpuser"

      - name: Download and Setup ngrok
        run: |
          # Download ngrok
          $ngrokUrl = "https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-windows-amd64.zip"
          $ngrokZip = "$env:TEMP
grok.zip"
          $ngrokDir = "$env:TEMP
grok"
          
          Invoke-WebRequest -Uri $ngrokUrl -OutFile $ngrokZip
          Expand-Archive -Path $ngrokZip -DestinationPath $ngrokDir -Force
          Remove-Item $ngrokZip
          
          # Authenticate ngrok
          & "$ngrokDir
grok.exe" config add-authtoken "${{ secrets.NGROK_AUTH_TOKEN }}"
          
          echo "NGROK_PATH=$ngrokDir
grok.exe" >> $env:GITHUB_ENV
          Write-Host "ngrok downloaded and authenticated"

      - name: Start ngrok RDP Tunnel
        run: |
          # Start ngrok tunnel di background
          $ngrokProcess = Start-Process -FilePath "$env:NGROK_PATH" `
            -ArgumentList "tcp", "3389" `
            -WindowStyle Hidden `
            -PassThru
          
          $pid = $ngrokProcess.Id
          echo "NGROK_PID=$pid" >> $env:GITHUB_ENV
          
          # Tunggu tunnel terbentuk
          Start-Sleep -Seconds 3
          
          # Ambil info dari API ngrok
          $response = Invoke-RestMethod -Uri "http://127.0.0.1:4040/api/tunnels"
          $tunnel = $response.tunnels[0]
          $publicUrl = $tunnel.public_url
          
          # Parse host dan port
          $publicUrl -match "tcp://(.+):(d+)" | Out-Null
          $host = $matches[1]
          $port = $matches[2]
          
          echo "NGROK_HOST=$host" >> $env:GITHUB_ENV
          echo "NGROK_PORT=$port" >> $env:GITHUB_ENV
          
          Write-Host "ngrok Tunnel: $publicUrl"

      - name: Display RDP Connection Info
        run: |
          Write-Host ""
          Write-Host "============================================"
          Write-Host "  ðŸ”’ RDP CONNECTION INFO (2 Hours)"
          Write-Host "============================================"
          Write-Host ""
          Write-Host "Host:     $env:NGROK_HOST"
          Write-Host "Port:     $env:NGROK_PORT"
          Write-Host "Username: rdpuser"
          Write-Host "Password: $env:RDP_PASSWORD"
          Write-Host ""
          Write-Host "Full Address: $env:NGROK_HOST`:$env:NGROK_PORT"
          Write-Host ""
          Write-Host "============================================"
          Write-Host ""

      - name: Keep Session Alive (2 Hours)
        run: |
          $endTime = (Get-Date).AddHours(2)
          
          while ((Get-Date) -lt $endTime) {
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] RDP active... (Press Ctrl+C to stop)"
            Start-Sleep -Seconds 60
          }
          
          Write-Host "2 hours reached. Session ending."
